# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

api.dave.io is a multipurpose personal API powered by Cloudflare Workers. It provides several endpoints:

- **Ping**: Simple health check endpoint
- **Redirect**: URL redirection service using KV storage
- **Dashboard**: Data feeds for dashboards (demo and Hacker News available)
- **RouterOS**: Generates RouterOS scripts for network configurations (currently implements put.io IP ranges, with more providers planned)

The API is built with [Hono](https://hono.dev) and uses [Chanfana](https://github.com/cloudflare/chanfana) for OpenAPI documentation and schema validation.

## Development Commands

### Setup and Development

```bash
# Install dependencies
bun install

# Start development server
bun run dev

# Generate Cloudflare Workers type definitions
bun run types

# Deploy to Cloudflare Workers
bun run deploy

# Run TypeScript type checking
bun run typecheck

# Lint code with Trunk and other linters
bun run lint

# Format code with Trunk
bun run format
```

## Code Architecture

- **Framework**: Uses Hono.js for routing and HTTP server functionality
- **API Documentation**: Uses Chanfana (OpenAPI) for documentation and schema validation
- **Type Safety**: Uses TypeScript and Zod for runtime type validation
- **Schema Organization**: Schemas are defined in `src/schemas/` directory using Zod
- **KV Storage**: Uses a unified KV namespace with hierarchical keys for data organization

### TypeScript Type Management

The project relies on Cloudflare Workers type definitions from the auto-generated `worker-configuration.d.ts` file. This approach ensures type definitions are always up-to-date with the current Wrangler configuration.

Key aspects of the type system:

1. **worker-configuration.d.ts**: Auto-generated by Wrangler (`bun run types`)
   - Contains all Cloudflare Workers types (KVNamespace, etc.)
   - Reference with `/// <reference path="../../worker-configuration.d.ts" />`

2. **src/schemas/cloudflare.types.ts**:
   - Extends the auto-generated types with project-specific additions
   - Adds custom environment bindings to the `Env` interface
   - Provides type safety for Cloudflare bindings

3. **Type Checking**:
   - Run `bun run typecheck` to verify type correctness
   - Ensures proper usage of Cloudflare Workers types throughout the codebase

### Key Components

1. **Endpoints**: Located in `src/endpoints/`

   - Each endpoint is implemented as a class extending `OpenAPIRoute` from Chanfana
   - Endpoints define their schema (for OpenAPI docs) and handling logic
   - Each endpoint has a consistent structure:
     - `schema`: Defines the OpenAPI documentation and Zod validation schema
     - `handle(c: Context)`: Processes the request and returns a response
2. **KV Utilities**: Located in `src/kv/`

   - Functionality for interacting with KV storage is abstracted into utility modules:
     - `dashboard.ts`: Handles dashboard-related KV operations
     - `redirect.ts`: Handles redirect-related KV operations
     - `routeros.ts`: Handles RouterOS-related KV operations
     - `metrics.ts`: Handles metrics tracking in KV
     - `init.ts`: Initializes KV storage with default values
   - Each utility module provides a consistent interface for its domain:
     - Functions for retrieving data
     - Functions for storing data
     - Functions for metadata management
3. **Analytics & Metrics**: Located in `src/lib/` and `src/kv/`

   - `analytics.ts`: Handles detailed request tracking via Analytics Engine
   - `metrics.ts`: Manages error tracking and status code metrics in KV storage
   - Each request is logged with detailed information:
     - Request details (path, method, timestamp)
     - Response details (status code, response time)
     - Client information (IP, user-agent, referrer)
4. **Cloudflare Integration**:

   - KV Namespace: Single unified namespace (`DATA`) for all storage needs
   - Analytics Engine: Tracks requests (`ANALYTICS`)
     - Each endpoint writes a data point with relevant information
     - Indexes are used for categorizing data points by endpoint type
5. **Command-line Utilities**: Located in `bin/`

   - `kv.ts`: Backup and restore utility for KV data
   - Run using Bun: `bun kv backup` or `bun kv restore <filename>`
   - Provides data management and disaster recovery capabilities

## File Structure

- `src/` - Main source code
  - `endpoints/` - API endpoint implementations
    - `ping.ts` - Simple health check endpoint
    - `redirect.ts` - URL redirection service
    - `dashboard.ts` - Dashboard data feed endpoints
    - `routeros.ts` - RouterOS script generator endpoints
  - `kv/` - KV storage operations
    - `redirect.ts` - KV storage operations for redirects
    - `routeros.ts` - KV storage operations for RouterOS data
    - `metrics.ts` - KV storage operations for metrics tracking
    - `init.ts` - KV initialization module
  - `lib/` - Utility libraries
    - `ip-address-utils.ts` - IP address utilities
  - `schemas/` - Zod schema definitions
    - `redirect.schema.ts` - Schemas for redirect functionality
    - `cloudflare.types.ts` - Type definitions for Cloudflare-specific objects
  - `index.ts` - Main application setup
  - `types.ts` - Type definitions
- `dashkit/` - Contains dashboard widget example
  - `feed.js` - Simple list panel implementation for dashboards
- `wrangler.jsonc` - Cloudflare Workers configuration

## Environment Setup

- The project uses [Bun](https://bun.sh/) (v1.2.13 or compatible) as the package manager and runtime
- [mise](https://mise.jdx.dev/) is used for environment management (optional)
- Environment variables are loaded from `.env` file when mise is active

## KV Storage Architecture

The API uses a unified KV namespace (`DATA`) with a hierarchical key structure for all data storage needs. This approach provides clean organization and makes it easier to manage different types of data in a single namespace.

### KV Key Structure

The key structure follows the pattern `topic:subtopic:resource` to organize different types of data:

1. **Redirects**: Prefix `redirect:`
   - `redirect:{slug}`: URL for the given redirect slug

2. **RouterOS**: Prefix `routeros:`
   - `routeros:putio:ipv4`: Cached IPv4 ranges for put.io
   - `routeros:putio:ipv6`: Cached IPv6 ranges for put.io
   - `routeros:putio:script`: Generated RouterOS script for put.io
   - `routeros:putio:metadata`: Provider-specific metadata for put.io

3. **Dashboard**: Prefix `dashboard:`
   - `dashboard:demo:items`: Items for the demo dashboard

4. **Metrics**: Prefix `metrics:`
   - `metrics:status:{code}`: Status code occurrence counter
   - `metrics:group:{group}`: Status code group counter (4xx, 5xx)
   - `metrics:routeros`: Shared metrics for all RouterOS endpoints
   - `metrics:redirect:{slug}`: Click tracking data for redirect slugs

### KV Utility Pattern

The code uses a consistent pattern for KV operations:

1. **Abstraction**: All KV operations are abstracted into dedicated modules in the `kv/` directory
   - `kv/redirect.ts` handles redirect-related operations
   - `kv/routeros.ts` handles RouterOS-related operations
   - `kv/metrics.ts` handles metrics tracking
   - `kv/init.ts` handles KV initialization

2. **Function Structure**: KV modules provide functions for:
   - Retrieving data from KV
   - Storing data in KV
   - Managing metadata and statistics
   - Error handling and logging

3. **Implementation**:
   ```typescript
   // Example function pattern
   export async function getData(env: { DATA: KVNamespace }, key: string): Promise<T | null> {
     try {
       const data = await env.DATA.get<T>(`prefix:${key}`, { type: "json" })
       return data
     } catch (error) {
       console.error("Error getting data for key", { key, error })
       return null
     }
   }
   ```

### Usage Pattern in Endpoints

Endpoints always interact with KV through these utility functions:

```typescript
// In endpoint handler
const redirect = await getRedirect(c.env, slug)

// Track usage
await trackRedirectClick(c.env, slug)
```

## Notes for Development

- The API is accessible at `api.dave.io` and `dave.io/api/*` when deployed
- Biome is used for code formatting and linting through Trunk
- CI/CD is implemented via GitHub Actions (`.github/workflows/`)
- For local development, the API runs on localhost with the port shown in the terminal when running `bun run dev`
- Always run `bun run typecheck` and `bun run lint` before submitting changes
- When adding new endpoints:
  1. Create a new file in `src/endpoints/`
  2. Implement a class extending `OpenAPIRoute` with schema and handle method
  3. Register the endpoint in `src/index.ts` using both direct and `/api/` prefixed paths
  4. Include appropriate analytics tracking using `c.env.ANALYTICS.writeDataPoint()`
- When adding new KV-backed functionality:
  1. Create a utility module in `src/kv/` for KV operations
  2. Follow the existing patterns for key structure and error handling
  3. Use the `DATA` KV namespace with appropriate key prefixes
  4. Update the `initializeKV()` function in `src/kv/init.ts` to handle new default values

## Recent Changes (2025-06-01)

### Enhanced Dashboard with KV Storage

In June 2025, the dashboard functionality was enhanced to use KV storage:

1. **KV-backed Dashboard Data**:
   - Added `src/kv/dashboard.ts` module for dashboard data operations
   - Dashboard items now stored in KV under `dashboard:demo:items`
   - Added initialization for dashboard data in KV

2. **Code Refactoring**:
   - Extracted common dashboard response patterns into helper methods
   - Improved error handling and fallback mechanisms
   - More consistent handling of response structure

3. **Documentation Updates**:
   - Updated README.md with dashboard KV structure
   - Added dashboard examples to CLAUDE.md

### Metrics and Analytics Enhancements

Comprehensive metrics and analytics were added to track API usage and performance:

1. **Metrics Tracking in KV**:
   - Added `src/kv/metrics.ts` for tracking non-success/non-redirect responses
   - Implemented counters for individual status codes (`metrics:status:{code}`)
   - Added group counters for 4xx and 5xx status codes (`metrics:group:{group}`)

2. **Enhanced Analytics Engine Integration**:
   - Added `src/lib/analytics.ts` for detailed request tracking
   - Implemented middleware in `src/index.ts` to capture detailed request info
   - Tracked data includes timestamps, paths, methods, status codes, response times, client info

3. **KV Admin Utility**:
   - Added `bin/kv.ts` command-line tool for KV data management
   - Implemented backup functionality to save KV data to JSON files
   - Added restore capability to recover from backups

### Improved KV Storage Architecture (2025-06-20)

The KV storage architecture was updated to improve data organization and management:

1. **Individual Key Structure for Metrics**:
   - Changed JSON object storage to individual keys for better organization
   - All metrics now use separate keys: `metrics:redirect:{slug}:count`, `metrics:routeros:cache-hits`, etc.
   - RouterOS metadata now uses a hierarchical structure: `routeros:putio:metadata:last-updated`

2. **Improved KV Admin Utility**:
   - Enhanced `bin/kv.ts` with intelligent value type handling
   - String values are now properly stored and restored without double quotes
   - Added wipe functionality to completely clear KV namespace with safety confirmations

3. **Updated Documentation**:
   - Revised KV namespace structure in README.md with new key patterns
   - Added documentation for type-specific value handling in KV operations

These improvements provide better data organization, more intuitive key naming, and more robust backup/restore functionality while maintaining the same clean architecture and development patterns.
