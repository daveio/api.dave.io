# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

api.dave.io is a multipurpose personal API powered by Cloudflare Workers. It provides several endpoints:

- **Ping**: Simple health check endpoint
- **Redirect**: URL redirection service using KV storage
- **Dashboard**: Data feeds for dashboards (demo and Hacker News available)
- **RouterOS**: Generates RouterOS scripts for network configurations (currently implements put.io IP ranges, with more providers planned)

The API is built with [Hono](https://hono.dev) and uses [Chanfana](https://github.com/cloudflare/chanfana) for OpenAPI documentation and schema validation.

## Development Commands

### Setup and Development

```bash
# Install dependencies
bun install

# Start development server
bun run dev

# Generate Cloudflare Workers type definitions
bun run types

# Deploy to Cloudflare Workers
bun run deploy

# Run TypeScript type checking
bun run typecheck

# Lint code with Trunk and other linters
bun run lint

# Format code with Trunk
bun run format
```

## Code Architecture

- **Framework**: Uses Hono.js for routing and HTTP server functionality
- **API Documentation**: Uses Chanfana (OpenAPI) for documentation and schema validation
- **Type Safety**: Uses TypeScript and Zod for runtime type validation
- **Schema Organization**: Schemas are defined in `src/schemas/` directory using Zod
- **KV Storage**: Uses a unified KV namespace with hierarchical keys for data organization
- **Durable Objects**: Used for stateful functionality like the RouterOS cache

### TypeScript Type Management

The project relies on Cloudflare Workers type definitions from the auto-generated `worker-configuration.d.ts` file. This approach ensures type definitions are always up-to-date with the current Wrangler configuration.

Key aspects of the type system:

1. **worker-configuration.d.ts**: Auto-generated by Wrangler (`bun run types`)
   - Contains all Cloudflare Workers types (KVNamespace, DurableObject, etc.)
   - Reference with `/// <reference path="../../worker-configuration.d.ts" />`

2. **src/schemas/cloudflare.types.ts**:
   - Extends the auto-generated types with project-specific additions
   - Adds custom environment bindings to the `Env` interface
   - Provides type safety for Cloudflare bindings

3. **Type Checking**:
   - Run `bun run typecheck` to verify type correctness
   - Ensures proper usage of Cloudflare Workers types throughout the codebase
   - Critical for Durable Objects and other Cloudflare-specific features

### Key Components

1. **Endpoints**: Located in `src/endpoints/`

   - Each endpoint is implemented as a class extending `OpenAPIRoute` from Chanfana
   - Endpoints define their schema (for OpenAPI docs) and handling logic
   - Each endpoint has a consistent structure:
     - `schema`: Defines the OpenAPI documentation and Zod validation schema
     - `handle(c: Context)`: Processes the request and returns a response
2. **KV Utilities**: Located in `src/lib/`

   - Functionality for interacting with KV storage is abstracted into utility modules:
     - `redirect-kv.ts`: Handles redirect-related KV operations
     - `routeros-kv.ts`: Handles RouterOS-related KV operations
   - Each utility module provides a consistent interface for its domain:
     - Functions for retrieving data
     - Functions for storing data
     - Functions for metadata management
3. **Cloudflare Integration**:

   - KV Namespace: Single unified namespace (`DATA`) for all storage needs
   - Analytics Engine: Tracks requests (`ANALYTICS`)
     - Each endpoint writes a data point with relevant information
     - Indexes are used for categorizing data points by endpoint type
4. **Main App Structure**:

   - `src/index.ts`: Entry point that sets up Hono app and registers routes
   - Uses Chanfana to generate OpenAPI documentation
5. **Utility Libraries**:

   - `src/lib/ip-address-utils.ts`: Custom IP address utilities for parsing and processing IP ranges
   - Preferred over external dependencies for better control and worker compatibility

## File Structure

- `src/` - Main source code
  - `endpoints/` - API endpoint implementations
    - `ping.ts` - Simple health check endpoint
    - `redirect.ts` - URL redirection service
    - `dashboard.ts` - Dashboard data feed endpoints
    - `routeros.ts` - RouterOS script generator endpoints
  - `kv/` - KV storage operations
    - `redirect.ts` - KV storage operations for redirects
    - `routeros.ts` - KV storage operations for RouterOS data
  - `lib/` - Utility libraries
    - `ip-address-utils.ts` - IP address utilities
  - `schemas/` - Zod schema definitions
    - `redirect.schema.ts` - Schemas for redirect functionality
    - `cloudflare.types.ts` - Type definitions for Cloudflare-specific objects
  - `index.ts` - Main application setup
  - `types.ts` - Type definitions
- `dashkit/` - Contains dashboard widget example
  - `feed.js` - Simple list panel implementation for dashboards
- `wrangler.jsonc` - Cloudflare Workers configuration

## Environment Setup

- The project uses [Bun](https://bun.sh/) (v1.2.13 or compatible) as the package manager and runtime
- [mise](https://mise.jdx.dev/) is used for environment management (optional)
- Environment variables are loaded from `.env` file when mise is active

## KV Storage Architecture

The API uses a unified KV namespace (`DATA`) with a hierarchical key structure for all data storage needs. This approach provides a clean organization and makes it easier to manage different types of data in a single namespace.

### KV Key Structure

The key structure follows the pattern `topic:subtopic:resource` to organize different types of data:

1. **Redirects**: Prefix `redirects:`
   - `redirects:{slug}`: URL for the given redirect slug

2. **RouterOS**: Prefix `routeros:`
   - `routeros:putio:ipv4`: Cached IPv4 ranges for put.io
   - `routeros:putio:ipv6`: Cached IPv6 ranges for put.io
   - `routeros:putio:script`: Generated RouterOS script for put.io
   - `routeros:putio:metadata`: Provider-specific metadata for put.io

3. **Metrics**: Prefix `metrics:`
   - `metrics:routeros`: Shared metrics for all RouterOS endpoints
   - `metrics:redirects:{slug}`: Click tracking data for redirect slugs

### KV Utility Pattern

The code uses a consistent pattern for KV operations:

1. **Abstraction**: All KV operations are abstracted into dedicated modules in the `kv/` directory
   - `kv/redirect.ts` handles redirect-related operations
   - `kv/routeros.ts` handles RouterOS-related operations

2. **Function Structure**: KV modules provide functions for:
   - Retrieving data from KV
   - Storing data in KV
   - Managing metadata and statistics
   - Error handling and logging

3. **Implementation**:
   ```typescript
   // Example function pattern
   export async function getData(env: { DATA: KVNamespace }, key: string): Promise<T | null> {
     try {
       const data = await env.DATA.get<T>(`prefix:${key}`, { type: "json" })
       return data
     } catch (error) {
       console.error("Error getting data for key", { key, error })
       return null
     }
   }
   ```

### Usage Pattern in Endpoints

Endpoints always interact with KV through these utility functions:

```typescript
// In endpoint handler
const redirect = await getRedirect(c.env, slug)

// Track usage
await trackRedirectClick(c.env, slug)
```

## Notes for Development

- The API is accessible at `api.dave.io` and `dave.io/api/*` when deployed
- Biome is used for code formatting and linting through Trunk
- CI/CD is implemented via GitHub Actions (`.github/workflows/`)
- For local development, the API runs on localhost with the port shown in the terminal when running `bun run dev`
- Always run `bun run typecheck` and `bun run lint` before submitting changes
- When adding new endpoints:
  1. Create a new file in `src/endpoints/`
  2. Implement a class extending `OpenAPIRoute` with schema and handle method
  3. Register the endpoint in `src/index.ts` using both direct and `/api/` prefixed paths
  4. Include appropriate analytics tracking using `c.env.ANALYTICS.writeDataPoint()`
- When adding new KV-backed functionality:
  1. Create a utility module in `src/lib/` for KV operations
  2. Follow the existing patterns for key structure and error handling
  3. Use the `DATA` KV namespace with appropriate key prefixes

## Recent Changes (2025-05-20)

### TypeScript Type Checking Fixes

Several improvements were made to the TypeScript type system:

1. **Type Resolution for Durable Objects**:
   - Fixed type errors in `src/durable-objects/routeros-cache.ts` for `DurableObject` and `DurableObjectState` types
   - Ensured proper referencing of the auto-generated `worker-configuration.d.ts` file

2. **Type System Approach**:
   - Simplified `src/schemas/cloudflare.types.ts` to focus on extending the auto-generated types
   - Added proper reference paths to worker-configuration.d.ts
   - Ensured compatibility with the `bun typecheck` command

3. **Type Generation**:
   - Verified the `bun run types` script correctly generates and updates type definitions
   - Added documentation about the type system in README.md and CLAUDE.md

These changes ensure proper type safety throughout the project, especially for Cloudflare-specific features like Durable Objects and KV namespaces.

### KV Storage Restructuring

In June 2024, the KV storage operations were restructured for better organization:

1. **Dedicated KV Directory**:
   - Created a new `src/kv/` directory dedicated to KV storage operations
   - Moved `src/lib/redirect-kv.ts` to `src/kv/redirect.ts`
   - Moved `src/lib/routeros-kv.ts` to `src/kv/routeros.ts`

2. **Import Path Updates**:
   - Updated all import paths in `src/endpoints/` files to reference the new KV module locations
   - Maintained the same function signatures for backward compatibility
   - No functional changes were made to the KV operations

3. **Documentation Updates**:
   - Updated project structure documentation in README.md and CLAUDE.md
   - Added notes about the new organization pattern

This restructuring provides better separation of concerns and makes the project structure more intuitive, with utility libraries in `lib/` and KV operations in `kv/`.

### Schema Migration

In July 2024, all schemas were migrated to dedicated schema files in the `/src/schemas` directory:

1. **Schema Organization**:
   - Created or updated the following schema files:
     - `redirect.schema.ts` - Schemas for URL redirection
     - `dashboard.schema.ts` - Schemas for dashboard data
     - `ping.schema.ts` - Schema for ping endpoint
     - `routeros.schema.ts` - Schemas for RouterOS functionality

2. **Code Updates**:
   - Updated all endpoint files to use schemas from the schemas directory
   - Updated KV utility files to use schema types
   - Maintained backward compatibility with the deprecated `types.ts` file
   - Fixed import statements to use `import type` for better performance

3. **Documentation Updates**:
   - Updated README.md with schema information
   - Enhanced the schemas README.md file

This reorganization improves code maintainability and makes it easier to reuse schemas across the codebase.

### KV Initialization at Startup

In August 2024, automatic KV initialization was added to ensure all KV stores have default values:

1. **New KV Initialization Module**:
   - Created a new `src/kv/init.ts` module that handles KV initialization
   - Implemented functions to initialize both RouterOS and Redirects KV stores
   - Uses a central `initializeKV()` function that's called on startup

2. **Default Value Handling**:
   - Added initialization of empty arrays for RouterOS IP ranges
   - Added initialization of metadata objects with null/empty values
   - Ensures metrics and tracking data structures exist with zero counts

3. **Middleware Integration**:
   - Added middleware in `src/index.ts` to run the initialization on each request
   - Ensures KV stores are properly initialized before endpoint handlers run
   - Gracefully handles any initialization errors without affecting request processing

4. **Code Updates**:
   - Updated KV utility files to export their constants for use in initialization
   - Enhanced existing code to safely handle empty or zero values

This feature improves the robustness of the API by ensuring that all necessary KV structures exist, even if empty, and that the code can gracefully handle these empty states without errors.
