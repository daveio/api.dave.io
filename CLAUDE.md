# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

api.dave.io is a multipurpose personal API powered by Cloudflare Workers. It provides several endpoints:

- **Ping**: Simple health check endpoint
- **Redirect**: URL redirection service using KV storage
- **Dashboard**: Data feeds for dashboards (demo and Hacker News available)
- **RouterOS**: Generates RouterOS scripts for network configurations (currently implements put.io IP ranges, with more providers planned)

The API is built with [Hono](https://hono.dev) and uses [Chanfana](https://github.com/cloudflare/chanfana) for OpenAPI documentation and schema validation.

## Development Commands

### Setup and Development

```bash
# Install dependencies
bun install

# Start development server
bun run dev

# Generate Cloudflare Workers type definitions
bun run types

# Deploy to Cloudflare Workers
bun run deploy

# Run TypeScript type checking
bun run typecheck

# Lint code with Trunk and Biome
bun run lint

# Format code with Trunk
bun run format

# Run KV backup/restore utility
bun kv backup           # Backup KV data matching patterns
bun kv backup --all     # Backup all KV data
bun kv restore <file>   # Restore KV data from backup
bun kv wipe             # Wipe all KV data (DANGEROUS!)
```

## Code Architecture

- **Framework**: Uses Hono.js for routing and HTTP server functionality
- **API Documentation**: Uses Chanfana (OpenAPI) for documentation and schema validation
- **Type Safety**: Uses TypeScript and Zod for runtime type validation
- **Schema Organization**: Schemas are defined in `src/schemas/` directory using Zod
- **KV Storage**: Uses a unified KV namespace with hierarchical keys for data organization
- **Analytics**: Uses Cloudflare Analytics Engine for request tracking

### Middleware Pipeline

The application uses a series of middleware to handle requests:

1. **KV Initialization**: Initializes KV with default values at startup
2. **Analytics Tracking**: Captures detailed request info for analytics
3. **Metrics Tracking**: Monitors non-success/non-redirect responses
4. **Endpoint Handlers**: Individual handlers for specific routes

### TypeScript Type Management

The project relies on Cloudflare Workers type definitions from the auto-generated `worker-configuration.d.ts` file. This approach ensures type definitions are always up-to-date with the current Wrangler configuration.

Key aspects of the type system:

1. **worker-configuration.d.ts**: Auto-generated by Wrangler (`bun run types`)
   - Contains all Cloudflare Workers types (KVNamespace, etc.)
   - Reference with `/// <reference path="../../worker-configuration.d.ts" />`

2. **src/schemas/cloudflare.types.ts**:
   - Extends the auto-generated types with project-specific additions
   - Adds custom environment bindings to the `Env` interface
   - Provides type safety for Cloudflare bindings

3. **Type Checking**:
   - Run `bun run typecheck` to verify type correctness
   - Ensures proper usage of Cloudflare Workers types throughout the codebase

### Key Components

1. **Endpoints**: Located in `src/endpoints/`

   - Each endpoint is implemented as a class extending `OpenAPIRoute` from Chanfana
   - Endpoints define their schema (for OpenAPI docs) and handling logic
   - Each endpoint has a consistent structure:
     - `schema`: Defines the OpenAPI documentation and Zod validation schema
     - `handle(c: Context)`: Processes the request and returns a response
2. **KV Utilities**: Located in `src/kv/`

   - Functionality for interacting with KV storage is abstracted into utility modules:
     - `dashboard.ts`: Handles dashboard-related KV operations
     - `redirect.ts`: Handles redirect-related KV operations
     - `routeros.ts`: Handles RouterOS-related KV operations
     - `metrics.ts`: Handles metrics tracking in KV
     - `init.ts`: Initializes KV storage with default values
   - Each utility module provides a consistent interface for its domain:
     - Functions for retrieving data
     - Functions for storing data
     - Functions for metadata management
3. **Analytics & Metrics**: Located in `src/lib/` and `src/kv/`

   - `analytics.ts`: Handles detailed request tracking via Analytics Engine
   - `metrics.ts`: Manages error tracking and status code metrics in KV storage
   - Each request is logged with detailed information:
     - Request details (path, method, timestamp)
     - Response details (status code, response time)
     - Client information (IP, user-agent, referrer)
4. **Cloudflare Integration**:

   - KV Namespace: Single unified namespace (`DATA`) for all storage needs
   - Analytics Engine: Tracks requests (`ANALYTICS`)
     - Each endpoint writes a data point with relevant information
     - Indexes are used for categorizing data points by endpoint type
5. **Command-line Utilities**: Located in `bin/`

   - `kv.ts`: Backup and restore utility for KV data
   - Run using Bun: `bun kv backup` or `bun kv restore <filename>`
   - Provides data management and disaster recovery capabilities

## File Structure

- `src/` - Main source code
  - `endpoints/` - API endpoint implementations
    - `ping.ts` - Simple health check endpoint
    - `redirect.ts` - URL redirection service
    - `dashboard.ts` - Dashboard data feed endpoints
    - `routeros.ts` - RouterOS script generator endpoints
  - `kv/` - KV storage operations
    - `dashboard.ts` - KV storage operations for dashboard data
    - `redirect.ts` - KV storage operations for redirects
    - `routeros.ts` - KV storage operations for RouterOS data
    - `metrics.ts` - KV storage operations for metrics tracking
    - `init.ts` - KV initialization module
  - `lib/` - Utility libraries
    - `analytics.ts` - Request tracking via Analytics Engine
    - `ip-address-utils.ts` - IP address utilities
  - `schemas/` - Zod schema definitions
    - `redirect.schema.ts` - Schemas for redirect functionality
    - `dashboard.schema.ts` - Schemas for dashboard functionality
    - `ping.schema.ts` - Schemas for ping endpoint
    - `routeros.schema.ts` - Schemas for RouterOS functionality
    - `cloudflare.types.ts` - Type definitions for Cloudflare-specific objects
  - `index.ts` - Main application setup
  - `types.ts` - Type definitions
- `dashkit/` - Contains dashboard widget example
  - `feed.js` - Simple list panel implementation for dashboards
- `bin/` - Command-line utilities
  - `kv.ts` - KV backup and restore utility
- `wrangler.jsonc` - Cloudflare Workers configuration

## Environment Setup

- The project uses [Bun](https://bun.sh/) (v1.2.13 or compatible) as the package manager and runtime
- [mise](https://mise.jdx.dev/) is used for environment management (optional)
- Environment variables are loaded from `.env` file when mise is active

## KV Storage Architecture

The API uses a unified KV namespace (`DATA`) with a hierarchical key structure for all data storage needs. This approach provides clean organization and makes it easier to manage different types of data in a single namespace.

### KV Key Structure

The key structure follows the pattern `topic:subtopic:resource` to organize different types of data:

1. **Redirects**: Prefix `redirect:`
   - `redirect:{slug}`: URL for the given redirect slug

2. **RouterOS**: Prefix `routeros:`
   - `routeros:putio:ipv4`: Cached IPv4 ranges for put.io
   - `routeros:putio:ipv6`: Cached IPv6 ranges for put.io
   - `routeros:putio:script`: Generated RouterOS script for put.io
   - `routeros:putio:metadata:last-updated`: Last update timestamp for put.io cache
   - `routeros:putio:metadata:last-error`: Last error message for put.io cache
   - `routeros:putio:metadata:last-attempt`: Last attempt timestamp for put.io cache
   - `routeros:putio:metadata:update-in-progress`: Flag indicating if update is in progress

3. **Dashboard**: Prefix `dashboard:`
   - `dashboard:demo:items`: Items for the demo dashboard

4. **Metrics**: Prefix `metrics:`
   - `metrics:status:{code}`: Status code occurrence counter
   - `metrics:group:{group}`: Status code group counter (4xx, 5xx)
   - `metrics:routeros:cache-resets`: Count of cache resets
   - `metrics:routeros:cache-hits`: Count of cache hits
   - `metrics:routeros:cache-misses`: Count of cache misses
   - `metrics:routeros:last-accessed`: Timestamp of last access
   - `metrics:routeros:last-refresh`: Timestamp of last refresh
   - `metrics:routeros:refresh-count`: Count of refreshes
   - `metrics:routeros:last-reset`: Timestamp of last reset
   - `metrics:routeros:reset-count`: Count of resets
   - `metrics:redirect:{slug}:count`: Count of redirects for a slug
   - `metrics:redirect:{slug}:last-accessed`: Timestamp of last access for a slug

### KV Utility Pattern

The code uses a consistent pattern for KV operations:

1. **Abstraction**: All KV operations are abstracted into dedicated modules in the `kv/` directory
   - `kv/redirect.ts` handles redirect-related operations
   - `kv/dashboard.ts` handles dashboard-related operations
   - `kv/routeros.ts` handles RouterOS-related operations
   - `kv/metrics.ts` handles metrics tracking
   - `kv/init.ts` handles KV initialization

2. **Function Structure**: KV modules provide functions for:
   - Retrieving data from KV
   - Storing data in KV
   - Managing metadata and statistics
   - Error handling and logging

3. **Implementation**:
   ```typescript
   // Example function pattern
   export async function getData(env: { DATA: KVNamespace }, key: string): Promise<T | null> {
     try {
       const data = await env.DATA.get<T>(`prefix:${key}`, { type: "json" })
       return data
     } catch (error) {
       console.error("Error getting data for key", { key, error })
       return null
     }
   }
   ```

### Usage Pattern in Endpoints

Endpoints always interact with KV through these utility functions:

```typescript
// In endpoint handler
const redirect = await getRedirect(c.env, slug)

// Track usage
await trackRedirectClick(c.env, slug)
```

## Analytics Integration

The API uses Cloudflare Analytics Engine for comprehensive request tracking:

1. **Middleware Integration**:
   - Captures request and response details
   - Measures response time
   - Logs client information

2. **Endpoint-Specific Tracking**:
   - Each endpoint implements custom analytics tracking
   - Uses appropriate indexes for categorization
   - Records endpoint-specific information

Example from the redirect endpoint:
```typescript
c.env.ANALYTICS.writeDataPoint({
  blobs: ["redirect_request", slug],
  indexes: ["redirect"]
})
```

## Notes for Development

- The API is accessible at `api.dave.io` and `dave.io/api/*` when deployed
- Biome is used for code formatting and linting through Trunk
- CI/CD is implemented via GitHub Actions (`.github/workflows/`)
- For local development, the API runs on localhost with the port shown in the terminal when running `bun run dev`
- Always run `bun run typecheck` and `bun run lint` before submitting changes
- When adding new endpoints:
  1. Create a new file in `src/endpoints/`
  2. Implement a class extending `OpenAPIRoute` with schema and handle method
  3. Register the endpoint in `src/index.ts` using both direct and `/api/` prefixed paths
  4. Include appropriate analytics tracking using `c.env.ANALYTICS.writeDataPoint()`
- When adding new KV-backed functionality:
  1. Create a utility module in `src/kv/` for KV operations
  2. Follow the existing patterns for key structure and error handling
  3. Use the `DATA` KV namespace with appropriate key prefixes
  4. Update the `initializeKV()` function in `src/kv/init.ts` to handle new default values

## KV Admin Utility

The project includes a comprehensive KV admin utility in `bin/kv.ts` for managing KV data:

1. **Backup Functionality**:
   - Backs up KV data to JSON files in the `_backup/` directory
   - Selective backup with regex pattern matching for keys
   - By default, backs up only dashboard demo items and redirects
   - Can backup all keys with the `--all` flag

2. **Restore Capability**:
   - Restores data from backup files
   - Preserves value types (strings vs. JSON)
   - Includes confirmation prompts for safety

3. **Data Wipe**:
   - Complete KV namespace cleanup
   - Multiple confirmation prompts to prevent accidents
   - Detailed progress reporting

4. **Value Type Handling**:
   - Intelligently handles different value types
   - String values are stored without additional quotes
   - JSON objects, arrays, and primitives are properly serialized

Usage:
```bash
bun kv backup             # Backup selected data
bun kv backup --all       # Backup all data
bun kv restore <file>     # Restore from backup
bun kv wipe               # Wipe all data (with confirmations)
```
